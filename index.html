<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pencarian Buku</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 20px;
    }

    h1 {
      color: #2c3e50;
      text-align: center;
    }

    .search-bar {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .search-bar input[type="text"] {
      width: 40%;
      padding: 12px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-right: 10px;
    }

    .search-bar button,
    .apply-button button {
      padding: 12px 20px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .filters {
      max-width: 1000px;
      margin: 0 auto 20px auto;
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: space-between;
    }

    .filter-group {
      flex: 1 1 200px;
    }

    .filter-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .filter-group select,
    .filter-group input[type="text"] {
      width: 100%;
      padding: 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .book-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    .book-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      transition: transform 0.2s;
    }

    .book-card:hover {
      transform: translateY(-5px);
    }

    .book-card img {
      width: 100%;
      height: 300px;
      object-fit: cover;
    }

    .book-info {
      padding: 15px;
    }

    .book-info h3 {
      font-size: 16px;
      margin: 0 0 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .book-info p {
      margin: 5px 0;
      font-size: 14px;
      color: #555;
    }

    .apply-button {
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>

  <h1>üìö Pencarian Buku</h1>

  <!-- Kolom pencarian -->
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Cari Judul Buku..." />
    <button onclick="applyFilters()">üîç Cari Buku</button>
  </div>

  <!-- Filter dan Sort -->
  <div class="filters">
    <div class="filter-group">
      <label for="genreFilter">Genre</label>
      <select id="genreFilter" onchange="updateFilterState()">
        <option value="">Semua Genre</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="yearSort">Urutkan Tahun</label>
      <select id="yearSort" onchange="updateFilterState()">
        <option value="">Tidak Ada</option>
        <option value="asc">Naik (Terlama ke Terbaru)</option>
        <option value="desc">Turun (Terbaru ke Terlama)</option>
      </select>
    </div>

    <div class="filter-group">
      <label for="ratingSort">Urutkan Rating</label>
      <select id="ratingSort" onchange="updateFilterState()">
        <option value="">Tidak Ada</option>
        <option value="asc">Rendah ke Tinggi</option>
        <option value="desc">Tinggi ke Rendah</option>
      </select>
    </div>
  </div>

  <div class="apply-button">
    <button onclick="applyFilters()">üîÑ Terapkan Filter & Sorting</button>
  </div>

  <!-- Tempat menampilkan buku -->
  <div class="book-list" id="bookList"></div>

  <script>
    let books = [];              // Data hasil filter
    let originalBooks = [];     // Data asli semua buku (untuk isi dropdown genre)

    // Simpan state filter saat ini
    let currentFilters = {
      keyword: "",
      genre: "",
      yearSort: "",
      ratingSort: ""
    };

    function updateFilterState() {
      currentFilters.genre = document.getElementById("genreFilter").value;
      currentFilters.yearSort = document.getElementById("yearSort").value;
      currentFilters.ratingSort = document.getElementById("ratingSort").value;
    }

    function applyFilters() {
      currentFilters.keyword = document.getElementById("searchInput").value.trim();

      let params = [];

      if (currentFilters.keyword) params.push("keyword=" + encodeURIComponent(currentFilters.keyword));
      if (currentFilters.genre) params.push("genre=" + encodeURIComponent(currentFilters.genre));
      if (currentFilters.yearSort) params.push("sort=year_" + currentFilters.yearSort);
      if (currentFilters.ratingSort) params.push("sort=rating_" + currentFilters.ratingSort);

      fetch('/api/books?' + params.join("&"))
        .then(res => {
          if (!res.ok) throw new Error("Gagal memuat data");
          return res.json();
        })
        .then(data => {
          console.log("‚úÖ Data diterima:", data); // Debug log
          books = data;
          renderBooks(books);
        })
        .catch(err => {
          console.error("‚ùå Error fetching data:", err);
          document.getElementById("bookList").innerHTML = "<p style='text-align:center'>Gagal memuat buku.</p>";
        });
    }

    function populateGenres() {
      const genreSet = new Set();

      // Gunakan originalBooks agar semua genre tetap muncul
      originalBooks.forEach(b => {
        if (b.Genre) genreSet.add(b.Genre);
      });

      const select = document.getElementById("genreFilter");
      select.innerHTML = '<option value="">Semua Genre</option>';
      genreSet.forEach(genre => {
        const option = document.createElement("option");
        option.value = genre;
        option.textContent = genre;
        select.appendChild(option);
      });

      // Restore nilai jika ada
      if (currentFilters.genre) select.value = currentFilters.genre;
    }

    function renderBooks(list) {
      const container = document.getElementById("bookList");
      container.innerHTML = "";

      if (list.length === 0) {
        container.innerHTML = "<p style='text-align:center'>Tidak ada buku ditemukan.</p>";
        return;
      }

      list.forEach(book => {
        const div = document.createElement("div");
        div.className = "book-card";

        div.innerHTML = `
          <img src="${book.Thumbnail || 'https://via.placeholder.com/220x300?text=No+Image'}" alt="${book.Title}" />
          <div class="book-info">
            <h3>${book.Title || 'Tidak ada judul'}</h3>
            <p><strong>Penulis:</strong> ${book.Authors || 'Tidak diketahui'}</p>
            <p><strong>Genre:</strong> ${book.Genre || '-'}</p>
            <p><strong>Tahun:</strong> ${book.Published_year || '-'}</p>
            <p><strong>Rating:</strong> ${book.Average_rating ? book.Average_rating.toFixed(2) : '-'}</p>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Muat data awal saat halaman dimuat
    window.onload = () => {
      fetch('/api/books')
        .then(res => res.json())
        .then(data => {
          originalBooks = [...data]; // üîπ Simpan salinan asli buku
          books = data;              // Default tampil semua buku
          populateGenres();          // Isi genre dari originalBooks
          renderBooks(books);
        })
        .catch(err => {
          console.error("Gagal muat awal:", err);
          document.getElementById("bookList").innerHTML = "<p style='text-align:center'>Gagal memuat buku awal.</p>";
        });
    };
  </script>
</body>
</html>